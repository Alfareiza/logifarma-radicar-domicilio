{% extends 'layouts/base.html' %}
{% load static %}
{% load my_filters %}
{% block extrastyle %}
<!-- datatable css https://datatables.net -->
<!--<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">-->
<link rel="stylesheet" href="{% static 'assets/plugins/chart-morris/css/morris.css' %}">
{% endblock extrastyle %}

{% block content %}
<div class="row">
    <div class="col-sm-12">
        <div class="card">
            <div class="card-header">
                <h5>Busca un usuario por su documento</h5>
            </div>
            <div class="card-block">
                <div class="row justify-content-center">
                    <div class="col-sm-6">
                        <input type="text" id="icon-search" class="form-control mb-4" placeholder="Digita el numero de documento...">
                        <button type="submit" class="btn btn-primary mb-2">Submit</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchButton = document.querySelector('.card-block button[type="submit"]');
    const searchInput = document.getElementById('icon-search');
    const cardBlock = document.querySelector('.card-block');

    searchButton.addEventListener('click', function(event) {
        event.preventDefault(); // Evita la recarga de la página al hacer clic en el botón

        const documento = searchInput.value.trim();
        if (documento) {
            const apiUrl = `http://domicilios.logifarma.com.co/api/v1/radicaciones/?paciente_cc=${documento}`;

            // Mostrar el spinner
            cardBlock.innerHTML = `
                <div class="row justify-content-center">
                    <div class="col-sm-6">
                        <input type="text" id="icon-search" class="form-control mb-4"
                               placeholder="Digita el numero de documento . . " value="${documento}">
                        <button type="submit" class="btn btn-primary mb-2">Submit</button>
                    </div>
                </div>
                <div class="d-flex justify-content-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            `;

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Limpiar el contenido actual del card-block
                    cardBlock.innerHTML = `
                        <div class="row justify-content-center">
                            <div class="col-sm-6">
                                <input type="text" id="icon-search" class="form-control mb-4" placeholder="Digita el numero de documento . . " value="${documento}">
                                <button type="submit" class="btn btn-primary mb-2">Submit</button>
                            </div>
                        </div>
                    `;
                    renderizarTabla(data.results, cardBlock);
                    // Volver a agregar el event listener al nuevo botón
                    const newSearchButton = cardBlock.querySelector('button[type="submit"]');
                    newSearchButton.addEventListener('click', arguments.callee); // Reutilizar la misma función
                })
                .catch(error => {
                    console.error('Error al llamar a la API:', error);
                    cardBlock.innerHTML = `
                        <div class="row justify-content-center">
                            <div class="col-sm-6">
                                <input type="text" id="icon-search" class="form-control mb-4" placeholder="Digita el numero de documento . . " value="${documento}">
                                <button type="submit" class="btn btn-primary mb-2">Submit</button>
                            </div>
                        </div>
                        <div class="alert alert-danger mt-3" role="alert">
                            Error al obtener los datos. Por favor, inténtalo de nuevo.
                        </div>
                    `;
                    // Volver a agregar el event listener al nuevo botón en caso de error
                    const newSearchButton = cardBlock.querySelector('button[type="submit"]');
                    newSearchButton.addEventListener('click', arguments.callee); // Reutilizar la misma función
                });
        } else {
            alert('Por favor, digita el número de documento.');
        }
    });

    function renderizarTabla(radicados, contenedor) {
        if (radicados && radicados.length > 0) {
            const tablaHTML = `
                <div class="table-responsive mt-3">
                    <table id="myTable" class="table table-hover display">
                        <thead>
                        <tr>
                            <th>Numero radicado</th>
                            <th>Celular</th>
                            <th>Municipio/Departamento</th>
                            <th>Fecha de radicado</th>
                            <th>Más</th>
                        </tr>
                        </thead>
                        <tbody>
                            ${radicados.map(rad => `
                                <tr class="unread">
                                    <td>
                                        <h6 class="m-0">${rad.numero_radicado}</h6>
                                        <p class="mb-1">${rad.paciente_nombre}</p>
                                    </td>
                                    <td>
                                        <h6 class="mb-1">${rad.cel_uno}</h6>
                                        <h6 class="text-muted">${rad.cel_dos || ''}</h6>
                                    </td>
                                    <td>
                                        <h6 class="mb-1">${rad.municipio.name || ''} / ${rad.municipio.departamento || ''}</h6>
                                        <h6 class="mb-1">${rad.direccion || ''}</h6>
                                    </td>
                                    <td>
                                        <h6 class="text-muted">
                                            ${new Date(rad.datetime).toLocaleDateString()} ${new Date(rad.datetime).toLocaleTimeString().slice(0, 5)}
                                        </h6>
                                    </td>
                                    <td>
                                        ${rad.acta_entrega ? `<span class="label theme-bg text-white f-12">${rad.acta_entrega}</span>` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            contenedor.insertAdjacentHTML('beforeend', tablaHTML);
        } else {
            contenedor.insertAdjacentHTML('beforeend', `
                <div class="alert alert-info mt-3" role="alert">
                    No se encontraron radicaciones para el documento ingresado.
                </div>
            `);
        }
    }
});
</script>
{% endblock extra_js %}
