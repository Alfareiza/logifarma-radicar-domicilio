#!/bin/bash
if [ "${NSCRIPTIOD_HTTP}" == "" ]; then
  echo "You must first install Nscriptiod:"
  echo "heroku addons:add nscriptiod:g10"
  exit 1
fi

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

#prepare credentials
creds=${NSCRIPTIOD_HTTP%%@*}
creds=$(echo $creds | cut -d/ -f3)
username=${creds%%:*}
password=${creds#*:}
url=${NSCRIPTIOD_HTTP#*@}
ip=${url%%:*}
ip=$(host $ip | awk '/has address/ { print $4 ; exit }')
port=${url#*:}

if [ -n "${NSC_DST_HOST}" ]; then
  echo "NSC_DST_HOST is defined, running in target proxy mode"
  if [ -z "${NSC_DST_PORT}" ]; then
    echo "NSC_DST_PORT variable is missing"
    exit 1
  fi
  
  listenPort="${NSC_LISTEN_PORT:-2356}"
  PROXY_USER="$username:$password" $SCRIPT_DIR/desproxy $NSC_DST_HOST $NSC_DST_PORT $ip $port $listenPort &
  "$@"
else
  echo "Running in global proxy mode"

  conf=/tmp/pxc.conf
  cat << EOF > $conf
strict_chain
proxy_dns
remote_dns_subnet 224
tcp_read_time_out 15000
tcp_connect_time_out 8000
[ProxyList]
EOF

  echo "http $ip $port $username $password" >> "$conf"

  $SCRIPT_DIR/proxychains4 -q -f $conf "$@"
fi
